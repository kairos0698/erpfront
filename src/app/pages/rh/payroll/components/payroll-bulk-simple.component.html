<p-toast></p-toast>

<p-dialog 
  [header]="getDialogHeader()" 
  [(visible)]="visible" 
  [modal]="true" 
  [closable]="true"
  [maximizable]="true">
  
  <div class="grid">
    <!-- Configuración del Período -->
    <div class="col-12">
      <div class="card">
        <h5>Configuración del Período de Pago</h5>
        <div class="flex items-center justify-center">
          <div class="col-6">
            <label class="block font-bold mb-2">Fecha Inicial *</label>
            <input 
              type="date" 
              pInputText 
              [(ngModel)]="startDate" 
              placeholder="Seleccionar fecha inicial"
              [disabled]="viewMode()"
              fluid>
          </div>
          <div class="col-6">
            <label class="block font-bold mb-2">Fecha Final *</label>
            <input 
              type="date" 
              pInputText 
              [(ngModel)]="endDate" 
              placeholder="Seleccionar fecha final"
              [disabled]="viewMode()"
              fluid>
          </div>
        </div>
        <div class="mt-3">
          <label class="block font-bold mb-2">Notas</label>
          <textarea 
            pTextarea 
            [(ngModel)]="notes" 
            rows="3" 
            placeholder="Notas adicionales sobre la nómina..."
            [disabled]="viewMode()"
            fluid>
          </textarea>
        </div>
      </div>
    </div>

    <!-- Selección de Empleados (solo visible en modo crear/editar) -->
    <div class="col-12" *ngIf="!viewMode()">
      <div class="card">
        <div class="flex justify-content-between align-items-center mb-3">
          <h5>Selección de Empleados</h5>
          <div class="flex gap-2">
            <p-button 
              label="Seleccionar Todos" 
              icon="pi pi-check" 
              size="small"
              (onClick)="selectAllEmployees()"
              *ngIf="!viewMode()">
            </p-button>
            <p-button 
              label="Deseleccionar Todos" 
              icon="pi pi-times" 
              size="small"
              severity="secondary"
              (onClick)="deselectAllEmployees()"
              *ngIf="!viewMode()">
            </p-button>
            <p-button 
              label="Calcular Nómina" 
              icon="pi pi-calculator" 
              size="small"
              severity="success"
              (onClick)="calculatePayroll()"
              [disabled]="selectedEmployees.length === 0 || viewMode()"
              [loading]="calculating"
              *ngIf="!viewMode()">
            </p-button>
          </div>
        </div>

        <p-table 
          [value]="employeeSelections" 
          [paginator]="true" 
          [rows]="10"
          [showCurrentPageReport]="true"
          currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} empleados"
          [rowsPerPageOptions]="[5,10,25]"
          [tableStyle]="{ 'min-width': '50rem' }">
          
          <ng-template #header>
            <tr>
              <th style="width: 3rem" *ngIf="!viewMode()">
                <p-checkbox 
                  [(ngModel)]="selectAll" 
                  (onChange)="toggleSelectAll($event)"
                  [binary]="true">
                </p-checkbox>
              </th>
              <th>Empleado</th>
              <th>Posición</th>
              <th>Salario</th>
              <th>Período de Pago</th>
              <th>Fecha de Contratación</th>
            </tr>
          </ng-template>
          
          <ng-template #body let-employeeSelection>
            <tr>
              <td *ngIf="!viewMode()">
                <p-checkbox 
                  [(ngModel)]="employeeSelection.selected" 
                  (onChange)="onEmployeeSelectionChange()"
                  [binary]="true">
                </p-checkbox>
              </td>
              <td>
                <div class="font-semibold">{{ employeeSelection.employee.firstName }} {{ employeeSelection.employee.lastName }}</div>
                <div class="text-sm text-600">{{ employeeSelection.employee.email }}</div>
              </td>
              <td>{{ employeeSelection.employee.positionName || 'Sin posición' }}</td>
              <td class="font-semibold">${{ employeeSelection.employee.salary | number:'1.2-2' }}</td>
              <td>
                <p-tag 
                  [value]="getPaymentPeriodDescription(employeeSelection.employee.paymentPeriod)"
                  [severity]="getPaymentPeriodSeverity(employeeSelection.employee.paymentPeriod)">
                </p-tag>
              </td>
              <td>{{ employeeSelection.employee.hireDate | date:'dd/MM/yyyy' }}</td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>

    <!-- Resultados del Cálculo -->
    <div class="col-12" *ngIf="calculationResult">
      <div class="card">
        <h5>Resultados del Cálculo</h5>
        <div class="flex items-center justify-between">
          <div class="col-3">
            <div class="text-center">
              <div class="text-2xl font-bold text-primary">{{ calculationResult.totalEmployees }}</div>
              <div class="text-sm text-600">Empleados</div>
            </div>
          </div>
          <div class="col-3">
            <div class="text-center">
              <div class="text-2xl font-bold text-green-600">${{ calculationResult.totalAmount | number:'1.2-2' }}</div>
              <div class="text-sm text-600">Total a Pagar</div>
            </div>
          </div>
          <div class="col-3">
            <div class="text-center">
              <div class="text-2xl font-bold text-orange-600">${{ calculationResult.totalBaseSalary | number:'1.2-2' }}</div>
              <div class="text-sm text-600">Salarios Base</div>
            </div>
          </div>
          <div class="col-3">
            <div class="text-center">
              <div class="text-2xl font-bold text-blue-600">${{ calculationResult.totalWorkOrdersAmount | number:'1.2-2' }}</div>
              <div class="text-sm text-600">Órdenes de Trabajo</div>
            </div>
          </div>
        </div>

        <!-- Detalle por Empleado con TreeTable -->
        <div class="mt-4">
          <h6>Detalle por Empleado</h6>
          <p-treetable 
            [value]="treeTableData" 
            [columns]="treeTableColumns"
            [rows]="10"
            [paginator]="true"
            [showCurrentPageReport]="true"
            currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} empleados"
            [rowHover]="true"
            [rowsPerPageOptions]="[10, 20, 30]"
            [scrollable]="true"
            dataKey="key"
            [tableStyle]="{ 'min-width': '75rem' }">
            
            <ng-template #header let-columns>
              <tr>
                <th *ngFor="let col of columns">
                  {{ col.header }}
                </th>
              </tr>
            </ng-template>
            
            <ng-template #body let-rowNode let-rowData="rowData" let-columns="columns" style="width: 50%;">
              <tr [ttRow]="rowNode">
                <td *ngFor="let col of columns; let i = index">
                  <span class="flex items-center gap-2">
                    <p-treeTableToggler [rowNode]="rowNode" *ngIf="i === 0" />
                    <ng-container [ngSwitch]="col.field">
                      <!-- Empleado -->
                      <span *ngSwitchCase="'employeeName'">
                        <!-- Para empleados -->
                        <div *ngIf="!rowData.workOrderName">
                          <div class="font-semibold">{{ rowData[col.field] }}</div>
                          <div class="text-sm text-600" *ngIf="rowData.position">{{ rowData.position }}</div>
                        </div>
                        <!-- Para órdenes de trabajo -->
                        <div *ngIf="rowData.workOrderName">
                          <div class="font-semibold text-blue-600">{{ rowData.workOrderName }}</div>
                          <div class="text-sm text-600" *ngIf="rowData.activityName">{{ rowData.activityName }}</div>
                          <div class="text-xs text-500 mt-1" *ngIf="rowData.phaseName">
                            <i class="pi pi-tag mr-1"></i>{{ rowData.phaseName }}
                          </div>
                          <div class="text-xs text-500" *ngIf="rowData.productName">
                            <i class="pi pi-box mr-1"></i>{{ rowData.productName }}
                          </div>
                          <div class="text-xs text-500" *ngIf="rowData.regionLotName">
                            <i class="pi pi-map-marker mr-1"></i>{{ rowData.regionLotName }}
                          </div>
                        </div>
                      </span>
                      
                      <!-- Período -->
                      <span *ngSwitchCase="'paymentPeriod'">
                        <p-tag
                          [value]="rowData.paymentPeriodDescription"
                          [severity]="getPaymentPeriodSeverity(rowData.paymentPeriod)"
                          *ngIf="rowData.paymentPeriod">
                        </p-tag>
                            <!-- Para órdenes de trabajo -->
                            <div *ngIf="rowData.workOrderDate" class="mt-2">
                            <div class="font-semibold">{{ rowData.workOrderDate | date:'dd/MM/yyyy' }}</div>
                            <div class="text-xs text-primary">Fecha de la Orden</div>
                            <!-- <div class="text-xs text-500">{{ rowData.workOrderDate | date:'HH:mm' }}</div> -->
                            </div>
                      </span>
                      
                      <!-- Salario Base -->
                      <span *ngSwitchCase="'baseSalary'">
                        <span *ngIf="rowData.baseSalary" class="font-semibold">${{ rowData.baseSalary | number:'1.2-2' }}</span>
                            <!-- Para órdenes de trabajo -->
                            <div *ngIf="rowData.productName" class="mt-2">
                                <div class="font-semibold">{{ rowData.productName }}</div>
                                <div class="text-xs text-primary">Producto Biológico</div>
                            </div>
                      </span>
                      
                      <!-- Calculado -->
                      <span *ngSwitchCase="'calculatedAmount'">
                        <span *ngIf="rowData.calculatedAmount" class="font-semibold">${{ rowData.calculatedAmount | number:'1.2-2' }}</span>
                            <!-- Para órdenes de trabajo -->
                            <div *ngIf="rowData.phaseName" class="mt-2">
                                <div class="font-semibold">{{ rowData.phaseName }}</div>
                                <div class="text-xs text-primary">Fase</div>
                            </div>
                      </span>
                      
                      <!-- Órdenes -->
                      <span *ngSwitchCase="'workOrdersAmount'">
                        <span *ngIf="rowData.workOrdersAmount" class="font-semibold">${{ rowData.workOrdersAmount | number:'1.2-2' }}</span>
                            <!-- Para órdenes de trabajo -->
                            <div *ngIf="rowData.employeeContribution" class="mt-2">
                                <div class="font-semibold text-green-600">${{ rowData.employeeContribution | number:'1.2-2' }}</div>
                                <div class="text-xs text-primary">Contribución</div>
                            </div>
                      </span>
                      
                      <!-- Total -->
                      <span *ngSwitchCase="'totalAmount'">
                        <div *ngIf="rowData.totalAmount" class="font-bold text-lg">${{ rowData.totalAmount | number:'1.2-2' }}</div>
                            <!-- Para órdenes de trabajo -->
                            <div *ngIf="rowData.activityName" class="mt-2">
                                <div class="font-semibold">{{ rowData.activityName }}</div>
                                <div class="text-xs text-primary">Actividad</div>
                            </div>
                      </span>
                      
                      <!-- Días -->
                      <span *ngSwitchCase="'periodDays'">
                        <span *ngIf="rowData.periodDays">{{ rowData.periodDays }} días</span>
                        
                      </span>
                      
                      <!-- Tasa Diaria -->
                      <span *ngSwitchCase="'dailyRate'">
                        <span *ngIf="rowData.dailyRate" class="font-semibold">${{ rowData.dailyRate | number:'1.2-2' }}/día</span>
                        <!-- Para órdenes de trabajo -->
                        <div *ngIf="rowData.regionLotName" class="mt-2">
                          <div class="font-semibold">{{ rowData.regionLotName }}</div>
                        </div>
                      </span>
                      
                      <span *ngSwitchDefault>{{ rowData[col.field] }}</span>
                    </ng-container>
                  </span>
                </td>
              </tr>
            </ng-template>
          </p-treetable>
        </div>
      </div>
    </div>
  </div>

  <ng-template #footer>
    <div class="flex justify-content-between">
      <p-button 
        label="Cancelar" 
        icon="pi pi-times" 
        [text]="true" 
        (onClick)="handleCancel()">
      </p-button>
      <div class="flex gap-2" *ngIf="!viewMode()">
        <p-button 
          [label]="payrollId() ? 'Actualizar Nóminas' : 'Crear Nóminas'" 
          icon="pi pi-check" 
          severity="success"
          (onClick)="createPayrolls()"
          [disabled]="!calculationResult"
          [loading]="creating">
        </p-button>
      </div>
    </div>
  </ng-template>
</p-dialog>
